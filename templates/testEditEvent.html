<!DOCTYPE html>
<html>
    <head>
        <title>Edit your event</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script type="text/javascript">
          var getUrlParameter = function getUrlParameter(sParam) {
              var sPageURL = window.location.search.substring(1),
                  sURLVariables = sPageURL.split('&'),
                  sParameterName,
                  i;

              for (i = 0; i < sURLVariables.length; i++) {
                  sParameterName = sURLVariables[i].split('=');

                  if (sParameterName[0] === sParam) {
                      return typeof sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                  }
              }
              return false;
          };

          let data;
          var event_id = getUrlParameter('event_id');

          function getCurrentEvent(){
            let deferred = $.Deferred();
            $.ajax({
              url: "http://localhost:5000/rest/events/edit?event_id=" + event_id,
              dataType: "json",
              type: "GET",
              success: function(result){
                data = result;
                deferred.resolve();
              }
            });
            return deferred.promise();
          };

          function postCurrentEvent(eventInfo){
            let deferred = $.Deferred();
            $.ajax({
              url: "http://localhost:5000/rest/events/edit?event_id=" + event_id,
              dataType: "json",
              type: "POST",
              data: {'data': eventInfo},
              success: function(){
                console.log("Updated successfully");
                deferred.resolve();
              }
            });
            return deferred.promise();
          }

          function loadCurrentEvent(currentEvent){
            $('#participating').val(currentEvent.people_participating);
            $('#needed').val(currentEvent.people_needed);
            $('#date').val(currentEvent.date);
            $('#time').val(currentEvent.time);
            $('#location').val(currentEvent.location);
            $('#price').val(currentEvent.price);
            $('#description').val(currentEvent.description);
          };

          $(document).ready(function(){
            $.when(getCurrentEvent()).done(function(){
              loadCurrentEvent(data);
              console.log(data);
              $("#formEdit").attr('action', '/myProfile/editEvent?event_id='+data['event_id']);

              $("#submit_btn").click(function(){
                $(".error").hide();
                var hasError = false;

                var selectedDate = new Date($("#date").val());
                var currentDate = new Date();
                if(selectedDate < currentDate){
                  $("#date").after('<span class="error">You cannot chose a previous date!</span>');
                  hasError = true;
                }

                var participatingVal = $("#participating").val();
                if(participatingVal <= 0){
                  $("#participating").after('<span class="error">The amount of people cannot be negative or 0!</span>');
                  hasError = true;
                }

                var neededVal = $("#needed").val();
                if(neededVal <= 0){
                  $("#needed").after('<span class="error">The amount of people cannot be negative or 0!</span>');
                  hasError = true;
                }

                var priceVal = $("#price").val();
                if(priceVal < 0){
                  $("#price").after('<span class="error">The price cannot be negative!</span>');
                  hasError = true;
                }


                if(hasError == true){return false;}
              });
            });
          });
        </script>

    </head>
    <body>
      <h1> Sports Eventer for {{currentUser}} </h1>
      <header>
          <button type="button" onclick="window.location='/'">Home</button>
      </header>

      <form id="formEdit" method="post">
        <label>People participating:</label>  <input type="number" id="participating" name="participating" required><br>
        <label>People needed:</label>         <input type="number" id="needed"        name="needed" required><br>
        <label>Date:</label>                  <input type="date"   id="date"          name="date"><br>
        <label>Time:</label>                  <input type="time"   id="time"          name="time"><br>
        <label>Location:</label>              <input type="text"   id="location"      name="location"><br>
        <label>Price per person:</label>      <input type="number" id="price"         name="price" required><br>
        <label>Short description:</label>     <input type="text"   id="description"   name="description"><br><br>
        <input id="submit_btn" type="submit" value="Submit">
      </form>

    </body>
</html>
